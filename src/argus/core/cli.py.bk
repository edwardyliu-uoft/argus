"""
Argus CLI - Command-line interface for running security analysis
"""

import asyncio
import sys
from pathlib import Path
import argparse
import logging

from argus.core.orchestrator.orchestrator import ArgusOrchestrator
from argus.core.config import conf


def setup_logging(verbose: bool = False):
    """Set up logging configuration."""
    level = logging.DEBUG if verbose else logging.INFO

    # Configure root logger
    logging.basicConfig(
        level=level, format="%(message)s", handlers=[logging.StreamHandler(sys.stdout)]
    )

    # Set argus.console logger
    logger = logging.getLogger("argus.console")
    logger.setLevel(level)


async def run_analysis(project_path: str, verbose: bool = False) -> int:
    """Run Argus security analysis on a project.

    Args:
        project_path: Path to the Hardhat project
        verbose: Enable verbose logging

    Returns:
        Exit code (0 for success, 1 for failure)
    """
    setup_logging(verbose)

    # Validate project path
    project = Path(project_path).resolve()
    if not project.exists():
        print(f"Error: Project path does not exist: {project}")
        return 1

    if not project.is_dir():
        print(f"Error: Project path is not a directory: {project}")
        return 1

    try:
        # Create and run orchestrator
        orchestrator = ArgusOrchestrator(str(project))
        result = await orchestrator.run()

        if result.get("success"):
            print("\nAnalysis completed successfully")
            print(f"   Contracts analyzed: {result.get('contracts_analyzed', 0)}")
            print(f"   Duration: {result.get('duration', 0):.1f}s")
            return 0
        else:
            print(f"\nAnalysis failed: {result.get('error', 'Unknown error')}")
            return 1

    except KeyboardInterrupt:
        print("\n\nAnalysis interrupted by user")
        return 1
    except Exception as e:
        print(f"\nUnexpected error: {e}")
        if verbose:
            import traceback

            traceback.print_exc()
        return 1


def main():
    """Main CLI entry point."""
    parser = argparse.ArgumentParser(
        description="Argus - Smart Contract Security Analysis",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Analyze a Hardhat project
  argus analyze ./my-project

  # Analyze with verbose output
  argus analyze ./my-project --verbose

  # Analyze the test project
  argus analyze examples/test-project
        """,
    )

    subparsers = parser.add_subparsers(dest="command", help="Command to run")

    # Analyze command
    analyze_parser = subparsers.add_parser(
        "analyze", help="Run security analysis on a Hardhat project"
    )
    analyze_parser.add_argument(
        "project_path", type=str, help="Path to the Hardhat project to analyze"
    )
    analyze_parser.add_argument(
        "-v", "--verbose", action="store_true", help="Enable verbose logging"
    )

    # Config command
    subparsers.add_parser("config", help="Show current configuration")

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        return 1

    if args.command == "analyze":
        exit_code = asyncio.run(run_analysis(args.project_path, args.verbose))
        sys.exit(exit_code)

    elif args.command == "config":
        print("Current Argus Configuration:")
        print("-" * 40)
        # Show key config values
        print(f"LLM Provider: {conf.get('orchestrator.llm', 'anthropic')}")
        print(
            f"MCP Server: {conf.get('server.host', '127.0.0.1')}:{conf.get('server.port', 8000)}"
        )
        print(f"Output Dir: {conf.get('output.directory', 'argus')}")
        return 0


if __name__ == "__main__":
    main()
